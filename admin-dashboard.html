<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Dashboard - Gadrel Collection</title>
  <link rel="stylesheet" href="styles/styles.css" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    @media (max-width: 768px) {
      .dashboard { padding: 10px; }
      .admin-section { margin-bottom: 20px; }
      table { display: block; overflow-x: auto; white-space: nowrap; }
      input, button, textarea { width: 100%; margin-bottom: 10px; }
      nav ul { flex-direction: column; }
    }

    body {
  font-family: 'Segoe UI', sans-serif;
  background-color: #F8F8F8;
  color: #021D34;
  margin: 0;
  padding: 0;
}

header {
  background-color: #021D34;
  color: #FFFFFF;
  padding: 1rem 2rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
}

.logo {
  font-size: 1.5rem;
  font-weight: bold;
}

nav ul {
  list-style: none;
  display: flex;
  gap: 1rem;
  padding: 0;
  margin: 0;
}

nav a {
  color: #F5E3C7;
  text-decoration: none;
  font-weight: bold;
}

.dashboard {
  padding: 2rem;
}

.admin-section {
  background-color: #FFFFFF;
  padding: 1.5rem;
  margin-bottom: 2rem;
  border-radius: 8px;
  box-shadow: 0 0 10px rgba(0,0,0,0.05);
}

.admin-section h3 {
  margin-bottom: 1rem;
  color: #021D34;
}

input, button, textarea {
  font-family: inherit;
  padding: 0.75rem;
  margin-bottom: 1rem;
  border: 1px solid #D9AF6C;
  border-radius: 6px;
  background-color: #F5E3C7;
  color: #021D34;
  width: 100%;
}

button {
  background-color: #D9AF6C;
  font-weight: bold;
  cursor: pointer;
}

button:hover {
  background-color: #c89a4f;
}

table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 1rem;
}

table th, table td {
  border: 1px solid #ccc;
  padding: 0.75rem;
  text-align: left;
}

footer {
  background-color: #021D34;
  color: #FFFFFF;
  text-align: center;
  padding: 2rem 1rem;
}

.social-links a {
  color: #D9AF6C;
  margin: 0 1rem;
  text-decoration: none;
}

  </style>
</head>
<body>
  <header>
    <div class="logo">GADREL COLLECTION</div>
    <nav>
      <ul>
        <li><a href="index.html">Home</a></li>
        <li class="dropdown">
          <a href="shop.html">Shop ‚ñæ</a>
          <ul class="dropdown-menu">
            <li><a href="men.html">Men</a></li>
            <li><a href="women.html">Women</a></li>
            <li><a href="accessories.html">Accessories</a></li>
            <li><a href="bags.html">Bags</a></li>
            <li><a href="beauty.html">Beauty</a></li>
            <li><a href="perfume.html">Perfume</a></li>
            <li><a href="earrings.html">Earrings</a></li>
          </ul>
        </li>
        <li><a href="about.html">About</a></li>
        <li><a href="contact.html">Contact</a></li>
        <li><a href="#" onclick="redirectIfNotLoggedIn('cart.html')">Cart üõí</a></li>
        <li class="dropdown">
          <a href="account.html">Account ‚ñæ</a>
          <ul class="dropdown-menu">
            <li><a href="signin.html">Sign In</a></li>
            <li><a href="signup.html">Sign Up</a></li>
            <li><a href="account.html">My Account</a></li>
            <li><a href="orders.html">Orders</a></li>
            <li><a href="wishlist.html">Wishlist</a></li>
          </ul>
        </li>
      </ul>
    </nav>
  </header>
<section class="dashboard">
  <h2>Admin Dashboard</h2>

  <!-- Product Form -->
  <div class="admin-section">
    <h3>Add / Edit Product</h3>
    <form id="product-form">
      <input type="text" id="name" placeholder="Product Name" required />
      <input type="number" id="price" placeholder="Price" required />
      <input type="text" id="image" placeholder="Image URL (optional)" />
      <input type="file" id="image-upload" />
      <input type="number" id="stock" placeholder="Stock Quantity" required />
      <button type="submit">Save Product</button>
    </form>
  </div>

  <!-- Product List -->
  <div class="admin-section">
    <h3>Manage Products</h3>
    <ul id="product-list"></ul>
  </div>

  <!-- Orders Table -->
  <div class="admin-section">
    <h3>Recent Orders</h3>
    <table id="orders-table">
      <thead>
        <tr>
          <th>User ID</th>
          <th>Total</th>
          <th>Status</th>
          <th>Items</th>
          <th>Created At</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- User Management -->
  <div class="admin-section">
    <h3>User Management</h3>
    <table id="users-table">
      <thead>
        <tr>
          <th>Email</th>
          <th>Admin</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Product Analytics -->
  <div class="admin-section">
    <h3>Product Analytics</h3>
    <div id="product-analytics"></div>
  </div>

  <!-- Sales Dashboard -->
  <div class="admin-section">
    <h3>Sales Dashboard</h3>
    <div id="sales-summary"></div>
  </div>

  <!-- Export Data -->
  <div class="admin-section">
    <h3>Export Data</h3>
    <button onclick="exportUsersToCSV()">Export Users</button>
    <button onclick="exportOrdersToCSV()">Export Orders</button>
  </div>

  <!-- Broadcast Message -->
  <div class="admin-section">
    <h3>Broadcast Message</h3>
    <form id="broadcast-form">
      <textarea id="broadcast-message" placeholder="Type your message here..." rows="4" required></textarea>
      <button type="submit">Send to All Users</button>
    </form>
  </div>

  <!-- Product Gallery -->
  <div class="admin-section">
    <h3>Product Gallery</h3>
    <div id="product-gallery" style="display: flex; flex-wrap: wrap; gap: 10px;"></div>
  </div>

  <!-- Admin Logs -->
  <div class="admin-section">
    <h3>Admin Activity Logs</h3>
    <ul id="log-list"></ul>
  </div>

  <!-- Revenue Chart -->
  <div class="admin-section">
    <h3>Monthly Revenue</h3>
    <canvas id="revenueChart" height="100"></canvas>
  </div>
</section>
<script>
  const SUPABASE_URL = "https://amrvwccagixmktagoecv.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFtcnZ3Y2NhZ2l4bWt0YWdvZWN2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMwNTEyMzksImV4cCI6MjA3ODYyNzIzOX0.I4lIPpprvDmD4Rs2ePlvnHXhdyyvmwxujAIE-8464Uw";
  const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  document.addEventListener("DOMContentLoaded", async () => {
    const { data: { user }, error } = await supabase.auth.getUser();
    if (error || !user) return window.location.href = "signin.html";

    const { data: profile, error: fetchError } = await supabase
      .from("users")
      .select("is_admin")
      .eq("id", user.id)
      .single();

    if (fetchError || !profile?.is_admin) {
      alert("Access denied. Admins only.");
      window.location.href = "index.html";
      return;
    }

    loadProducts();
    loadOrders();
    loadUsers();
    loadProductAnalytics();
    loadSalesDashboard();
    loadProductGallery();
    loadLogs();
    loadRevenueChart();
  });

  async function loadProducts() {
    const { data } = await supabase.from("products").select("*");
    const list = document.getElementById("product-list");
    list.innerHTML = "";

    data.forEach(product => {
      const li = document.createElement("li");
      li.innerHTML = `
        <strong>${product.name}</strong> ‚Äì ‚Ç¶${product.price} ‚Äì Stock: ${product.stock}<br>
        <img src="${product.image}" alt="${product.name}" width="100"><br>
        <button onclick="editProduct(${product.id}, '${product.name}', ${product.price}, '${product.image}', ${product.stock})">Edit</button>
        <button onclick="deleteProduct(${product.id})">Delete</button>
        <hr>
      `;
      list.appendChild(li);
    });
  }

  function editProduct(id, name, price, image, stock) {
    document.getElementById("name").value = name;
    document.getElementById("price").value = price;
    document.getElementById("image").value = image;
    document.getElementById("stock").value = stock;
    document.getElementById("product-form").dataset.editId = id;
  }

  async function deleteProduct(id) {
    if (!confirm("Are you sure you want to delete this product?")) return;
    await supabase.from("products").delete().eq("id", id);
    loadProducts();
  }

  document.getElementById("product-form").addEventListener("submit", async (e) => {
    e.preventDefault();
    const name = document.getElementById("name").value;
    const price = parseFloat(document.getElementById("price").value);
    const stock = parseInt(document.getElementById("stock").value);
    const fileInput = document.getElementById("image-upload");
    const file = fileInput.files[0];
    let image = document.getElementById("image").value;
    const editId = document.getElementById("product-form").dataset.editId;

    if (file) {
      const { data, error } = await supabase.storage
        .from("product-images")
        .upload(`products/${Date.now()}_${file.name}`, file);

      if (error) return alert("Upload failed: " + error.message);

      const { data: publicUrl } = supabase.storage
        .from("product-images")
        .getPublicUrl(data.path);

      image = publicUrl.publicUrl;
    }

    if (editId) {
      await supabase.from("products").update({ name, price, image, stock }).eq("id", editId);
      delete document.getElementById("product-form").dataset.editId;
    } else {
      await supabase.from("products").insert({ name, price, image, stock });
    }

    e.target.reset();
    loadProducts();
  });

  async function loadOrders() {
    const { data: orders } = await supabase
      .from("orders")
      .select("id, user_id, total, status, created_at, order_items (product_id, quantity)")
      .order("created_at", { ascending: false });

    const tbody = document.querySelector("#orders-table tbody");
    tbody.innerHTML = "";

    if (!orders?.length) {
      tbody.innerHTML = "<tr><td colspan='5'>No orders found.</td></tr>";
      return;
    }

    orders.forEach(order => {
      const items = order.order_items.map(i => `Product ${i.product_id} √ó ${i.quantity}`).join("<br>");
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${order.user_id}</td>
        <td>‚Ç¶${order.total}</td>
        <td>${order.status}</td>
        <td>${items}</td>
        <td>${new Date(order.created_at).toLocaleString()}</td>
      `;
      tbody.appendChild(row);
    });
  }

  async function loadUsers() {
    const { data: users } = await supabase.from("users").select("id, email, is_admin");
    const tbody = document.querySelector("#users-table tbody");
    tbody.innerHTML = "";

    users.forEach(user => {
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${user.email}</td>
        <td>${user.is_admin ? "‚úÖ" : "‚ùå"}</td>
        <td>
          <button onclick="toggleAdmin('${user.id}', ${user.is_admin})">
            ${user.is_admin ? "Demote" : "Promote"}
          </button>
          <button onclick="deleteUser('${user.id}')">Delete</button>
        </td>
      `;
      tbody.appendChild(row);
    });
  }

  async function toggleAdmin(userId, currentStatus) {
    await supabase.from("users").update({ is_admin: !currentStatus }).eq("id", userId);
    loadUsers();
  }

  async function deleteUser(userId) {
    if (!confirm("Delete this user?")) return;
    await supabase.from("users").delete().eq("id", userId);
    loadUsers();
  }

  async function loadProductAnalytics() {
    const { data: items } = await supabase.from("order_items").select("product_id, quantity");
    const totals = {};
    items.forEach(i => {
      totals[i.product_id] = (totals[i.product_id] || 0) + i.quantity;
    });

    const { data: products } = await supabase.from("products").select("id, name, stock");
    const container = document.getElementById("product-analytics");
    container.innerHTML = "<ul>";

    products.forEach(p => {
      const sold = totals[p.id] || 0;
      const lowStock = p.stock < 5 ? "‚ö†Ô∏è Low Stock" : "";
      container.innerHTML += `<li><strong>${p.name}</strong>: Sold ${sold}, Stock ${p.stock} ${lowStock}</li>`;
    });

    container.innerHTML += "</ul>";
  }

  async function loadSalesDashboard() {
    const { data: orders } = await supabase.from("orders").select("total, created_at");
    const totalRevenue = orders.reduce((sum, o) => sum + o.total, 0);
    const totalOrders = orders.length;
    const recent = orders.filter(o => new Date(o.created_at) > new Date(Date.now() - 7 * 86400000)).length;

    document.getElementById("sales-summary").innerHTML = `
      <p>Total Revenue: ‚Ç¶${totalRevenue}</p>
      <p>Total Orders: ${totalOrders}</p>
      <p>Orders This Week: ${recent}</p>
    `;
  }

  function convertToCSV(data, headers) {
    const csvRows = [headers.join(",")];
    data.forEach(row => {
      const values = headers.map(h => `"${row[h] ?? ""}"`);
      csvRows.push(values.join(","));
    });
    return csvRows.join("\n");
  }

  function downloadCSV(filename, csv) {
    const blob = new Blob([csv], { type: "text/csv" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    a.click();
    URL.revokeObjectURL(url);
  }

  async function exportUsersToCSV() {
    const { data: users } = await supabase.from("users").select("id, email, is_admin");
    const csv = convertToCSV(users, ["id", "email", "is_admin"]);
    downloadCSV("users.csv", csv);
  }

  async function exportOrdersToCSV() {
    const { data: orders } = await supabase.from("orders").select("id, user_id, total, status, created_at");
    const csv = convertToCSV(orders, ["id", "user_id", "total", "status", "created_at"]);
    downloadCSV("orders.csv", csv);
  }

  document.getElementById("broadcast-form").addEventListener("submit", async (e) => {
    e.preventDefault();
    const message = document.getElementById("broadcast-message").value;

    const { data: users } = await supabase.from("users").select("email");
    const emails = users.map(u => u.email);

    console.log("Broadcasting to:", emails);
    console.log("Message:", message);

    alert("Broadcast simulated. Connect to SendGrid or Mailchimp to send real emails.");
  });

  async function loadProductGallery() {
    const { data: products } = await supabase.from("products").select("name, image");
    const gallery = document.getElementById("product-gallery");
    gallery.innerHTML = "";

    products.forEach(p => {
      const div = document.createElement("div");
      div.innerHTML = `
        <img src="${p.image}" alt="${p.name}" width="100"><br>
        <small>${p.name}</small>
      `;
      gallery.appendChild(div);
    });
  }

  async function loadLogs() {
    const { data: logs } = await supabase
      .from("logs")
      .select("action, timestamp")
      .order("timestamp", { ascending: false });

    const list = document.getElementById("log-list");
    list.innerHTML = "";
    logs.forEach(log => {
      const li = document.createElement("li");
      li.textContent = `${new Date(log.timestamp).toLocaleString()} ‚Äî ${log.action}`;
      list.appendChild(li);
    });
  }

  async function loadRevenueChart() {
    const { data: orders } = await supabase
      .from("orders")
      .select("total, created_at");

    const monthlyTotals = {};

    orders.forEach(order => {
      const month = new Date(order.created_at).toLocaleString("default", { month: "short", year: "numeric" });
      monthlyTotals[month] = (monthlyTotals[month] || 0) + order.total;
    });

    const labels = Object.keys(monthlyTotals);
    const values = Object.values(monthlyTotals);

    new Chart(document.getElementById("revenueChart"), {
      type: "bar",
      data: {
        labels,
        datasets: [{
          label: "Revenue (‚Ç¶)",
          data: values,
          backgroundColor: "#4e73df"
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { display: false }
        }
      }
    });
  }
</script>
<footer>
  <p>&copy; 2025 Gadrel Collection. All rights reserved.</p>
  <div class="social-links">
    <a href="https://instagram.com/gadrelcollection">Instagram</a>
    <a href="mailto:johnamoke18@gmail.com">Email Us</a>
    <a href="https://wa.me/2348105429924">Chat on WhatsApp</a>
  </div>
</footer>
</body>
</html>
