<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Dashboard - Gadrel Collection</title>
  <link rel="stylesheet" href="styles/styles.css" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <header>
    <div class="logo">GADREL COLLECTION</div>
    <nav>
      <ul>
        <li><a href="index.html">Home</a></li>
        <li class="dropdown">
          <a href="shop.html">Shop â–¾</a>
          <ul class="dropdown-menu">
            <li><a href="men.html">Men</a></li>
            <li><a href="women.html">Women</a></li>
            <li><a href="accessories.html">Accessories</a></li>
            <li><a href="bags.html">Bags</a></li>
            <li><a href="beauty.html">Beauty</a></li>
            <li><a href="perfume.html">Perfume</a></li>
            <li><a href="earrings.html">Earrings</a></li>
          </ul>
        </li>
        <li><a href="about.html">About</a></li>
        <li><a href="contact.html">Contact</a></li>
        <li><a href="#" onclick="redirectIfNotLoggedIn('cart.html')">Cart ðŸ›’</a></li>
        <li class="dropdown">
          <a href="account.html">Account â–¾</a>
          <ul class="dropdown-menu">
            <li><a href="signin.html">Sign In</a></li>
            <li><a href="signup.html">Sign Up</a></li>
            <li><a href="account.html">My Account</a></li>
            <li><a href="orders.html">Orders</a></li>
            <li><a href="wishlist.html">Wishlist</a></li>
          </ul>
        </li>
      </ul>
    </nav>
  </header>

  <section class="dashboard">
    <h2>Admin Dashboard</h2>

    <!-- Product Form -->
    <div class="admin-section">
      <h3>Add / Edit Product</h3>
      <form id="product-form">
        <input type="text" id="name" placeholder="Product Name" required />
        <input type="number" id="price" placeholder="Price" required />
        <input type="text" id="image" placeholder="Image URL (optional)" />
        <input type="file" id="image-upload" />
        <input type="number" id="stock" placeholder="Stock Quantity" required />
        <button type="submit">Save Product</button>
      </form>
    </div>

    <!-- Product List -->
    <div class="admin-section">
      <h3>Manage Products</h3>
      <ul id="product-list"></ul>
    </div>

    <!-- Orders Table -->
    <div class="admin-section">
      <h3>Recent Orders</h3>
      <table id="orders-table">
        <thead>
          <tr>
            <th>User ID</th>
            <th>Total</th>
            <th>Status</th>
            <th>Items</th>
            <th>Created At</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <footer>
    <p>&copy; 2025 Gadrel Collection. All rights reserved.</p>
    <div class="social-links">
      <a href="https://instagram.com/gadrelcollection">Instagram</a>
      <a href="mailto:johnamoke18@gmail.com">Email Us</a>
      <a href="https://wa.me/2348105429924">Chat on WhatsApp</a>
    </div>
  </footer>

  <script>
    const SUPABASE_URL = "https://amrvwccagixmktagoecv.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFtcnZ3Y2NhZ2l4bWt0YWdvZWN2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMwNTEyMzksImV4cCI6MjA3ODYyNzIzOX0.I4lIPpprvDmD4Rs2ePlvnHXhdyyvmwxujAIE-8464Uw";
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    document.addEventListener("DOMContentLoaded", async () => {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) return window.location.href = "signin.html";

      const { data: profile } = await supabase
        .from("profiles")
        .select("is_admin")
        .eq("id", user.id)
        .single();

      if (!profile?.is_admin) {
        alert("Access denied. Admins only.");
        window.location.href = "index.html";
      } else {
        loadProducts();
        loadOrders();
      }
    });

    async function loadProducts() {
      const { data } = await supabase.from("products").select("*");
      const list = document.getElementById("product-list");
      list.innerHTML = "";

      data.forEach(product => {
        const li = document.createElement("li");
        li.innerHTML = `
          <strong>${product.name}</strong> â€“ â‚¦${product.price} â€“ Stock: ${product.stock}<br>
          <img src="${product.image}" alt="${product.name}" width="100"><br>
          <button onclick="editProduct(${product.id}, '${product.name}', ${product.price}, '${product.image}', ${product.stock})">Edit</button>
          <button onclick="deleteProduct(${product.id})">Delete</button>
          <hr>
        `;
        list.appendChild(li);
      });
    }

    function editProduct(id, name, price, image, stock) {
      document.getElementById("name").value = name;
      document.getElementById("price").value = price;
      document.getElementById("image").value = image;
      document.getElementById("stock").value = stock;
      document.getElementById("product-form").dataset.editId = id;
    }

    async function deleteProduct(id) {
      if (!confirm("Are you sure you want to delete this product?")) return;
      await supabase.from("products").delete().eq("id", id);
      loadProducts();
    }

    document.getElementById("product-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      const name = document.getElementById("name").value;
      const price = parseFloat(document.getElementById("price").value);
      const stock = parseInt(document.getElementById("stock").value);
      const fileInput = document.getElementById("image-upload");
      const file = fileInput.files[0];
      let image = document.getElementById("image").value;
      const editId = document.getElementById("product-form").dataset.editId;

      if (file) {
        const { data, error } = await supabase.storage
          .from("product-images")
          .upload(`products/${Date.now()}_${file.name}`, file);

        if (error) return alert("Upload failed: " + error.message);

        const { data: publicUrl } = supabase.storage
          .from("product-images")
          .getPublicUrl(data.path);

        image = publicUrl.publicUrl;
      }

      if (editId) {
        await supabase
          .from("products")
          .update({ name, price, image, stock })
          .eq("id", editId);
        delete document.getElementById("product-form").dataset.editId;
      } else {
        await supabase
          .from("products")
          .insert({ name, price, image, stock });
      }

      e.target.reset();
      loadProducts();
    });

    async function loadOrders() {
      const { data: orders } = await supabase
        .from("orders")
        .select("id, user_id, total, status, created_at, order_items (product_id, quantity)")
        .order("created_at", { ascending: false });

      const tbody = document.querySelector("#orders-table tbody");
      tbody.innerHTML = "";

      if (!orders?.length) {
        tbody.innerHTML = "<tr><td colspan='5'>No orders found.</td></tr>";
        return;
      }

      orders.forEach(order => {
        const items = order.order_items.map(i => `Product ${i.product_id} Ã— ${i.quantity}`).join("<br>");
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${order.user_id}</td>
          <td>â‚¦${order.total}</td>
          <td>${order.status}</td>
          <td>${items}</td>
          <td>${new Date(order.created_at).toLocaleString()}</td>
        `;
        tbody.appendChild(row);
      });
    }
  </script>
</body>
</html>
